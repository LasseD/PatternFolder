<!DOCTYPE html>
<html>
 <head>
    <meta charset=utf-8>
    <title>Pattern Folder - Fold LDraw stickers and prints</title>
    <meta name="viewport" content="width=device-width" />
    <style>
      body {
        font-family: "Arial","Helvetica",sans-serif;
        padding: 0;
        margin: 0;
        background-color: #EEE;
      }
      h1, h3 {
        text-transform: uppercase;
        display: block;
        text-align: center;
        margin: 0;
        padding: 0.5em;
        font-size: 2em;
      }
      h1 {
        background-color: #000;
        color: white;
      }
      h3 {
        background-color: #D9D;
      }
      .section {
        display: block;
        margin: 0.5em;
      }
      .desc {
        margin: 0.5em;
      }
      .choice {
        display: table;
        margin: 0.5em;
      }
      .choice, textarea, button {
        display: block;
        width: 95%;
      }
      button {
        height: 4em;
      }
      #contact {
        margin: 2em;
        text-align: center;
      }
      .error, .warning {
        display: block;
        margin: 1em;
        padding: 0.5em;
        font-weigght: bold;
      }
      .error {
        border: 0.2em solid red;
      }
      .warning {
        border: 0.2em solid orange;
      }
      canvas {
        display: block;
        margin: auto;
      }

      #maps {
        margin-top: 0.5em;
      }
      .map {
        display: inline-block;
        width: 100px;
        height: 100px;
        background-color: #FFF;
        margin-right: 1em;
        margin-bottom: 1em;
        text-align: center;
        padding-top: 0.2em;
      }
      .map .title {
        display: inline;
      }
    </style>
 </head>
 <body>
  <script src="js/three.min.js"></script>
  <script src="js/OrbitControls.js"></script>
  <script src="js/jquery.min.js"></script>
  <script src="js/colors.js"></script>
  <script src="js/geometry.js"></script>
  <script src="js/height_map.js"></script>
  <script src="js/pattern_folder.js"></script>
  <script src="js/LDROptions.js"></script>
  <script src="js/LDRShaders.js"></script>
  <script src="js/LDRColorMaterials.js"></script>
  <script src="js/LDRGeometries.js"></script>
  <script src="js/LDRLoader.js"></script>
  <script src="js/maps.js"></script>
  
  <h1>Pattern Folder - Fold LDraw stickers and prints</h1>

  <h3>Step 1 - sticker/print</h3>
  <div class="section">
   <span class="desc">
     Select the LDraw pattern which represents either a sticker or a print.
     This can be done using either a URL, a file, or by pasting the content into the text area below
   </span>
   <span class="choice">
    <label for="url">URL from a website</label>
    <input id="url" name="url" type="text" onchange="readFromUrl(event);" />
   </span>
   <span class="choice">
    <label for="file">DAT or LDR file on your device</label>
    <input id="file" name="file" type="file" onchange="readFromFile(event);" />
   </span>
   <span class="choice">
    <textarea id="file_content" onkeyup="fold(null)" rows="8">0 Or paste the content of the LDraw file here. Such as:
2 0 -100 0 0 100 0 0
</textarea>
   </span>

   <div id="warnings">
   </div>
   <div id="errors">
   </div>

   <div id="preview1"></div>
  </div>

  <h3>Step 2 - Surface</h3>
  <div class="section">
   <span class="desc">
     Select the surface onto which the pattern should be folded. 
     If your preferred surface is not present, then you can set the surface manually in the text area below.
   </span>
   <div id="maps">
   </div>
   <span class="choice">
    <textarea id="surface" onkeyup="fold(null)" rows="3"
>#Example: Horizontal height map.
horizontal 0
-100 -100 -40 -30 0 0 40 30 100 100
</textarea>
   </span>
  </div>

  <h3>Step 3 - Get the result</h3>
  <div class="section">
   <div id="preview2"></div>
   <span class="choice">
     <textarea id="ldr_result" rows="10"></textarea>
     <button onclick="copyToClipboard();">Copy LDraw File to Clipboard</button>
   </span>
  </div>

  <div id="contact">
    <a href="https://github.com/LasseD/PatternFolder">PatternFolder</a> is in the public domain and may be freely distributed.
    <a href="https://github.com/mrdoob/three.js">three.js and OrbitControls.js</a> use the MIT license.
    Contact: Lasse Deleuran on <a href="mailto:lasse.deleuran@gmail.com">lasse.deleuran@gmail.com</a>.
  </div>

  <script>
/*
  Warnings and errors:
 */
var seenWarningTypes = {};
function resetWarningsAndErrors() {
  $('#warnings').empty();
  $('#errors').empty();
  seenWarningTypes = {};
}
function onWarning(type, message) {
  console.warn(message);
  if(seenWarningTypes.hasOwnProperty(type)) {
    return; // Already seen.
  }

  message = message.replace('<', '&lt;');

  var span = document.createElement('span');
  span.setAttribute('class', 'warning');
  span.innerHTML = message;
  $('#warnings').append(span);
  
  seenWarningTypes[type] = true;
}
function onError(message) {
  var span = document.createElement('span');
  span.setAttribute('class', 'error');
  span.innerHTML = message;
  $('#errors').empty().append(span);
}

/*
  three.js rendering:
 */
var ldrOptions = new LDR.Options(); // Determine how to show lines. Change this in sample_instruction.htm

// Set up camera:
var camera1 = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 1000000);
var camera2 = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 1000000);
camera1.position.set(10000, 7000, 10000); camera2.position.set(10000, 7000, 10000);
camera1.lookAt(new THREE.Vector3()); camera2.lookAt(new THREE.Vector3());

// Set up scene:
var scene1 = new THREE.Scene(), scene2 = new THREE.Scene(); // Original and folded.
scene1.background = scene2.background = new THREE.Color(0xFFFFFF);
var baseObject1, baseObject2;

// Set up renderer:
var renderer1 = new THREE.WebGLRenderer({antialias: true}), renderer2 = new THREE.WebGLRenderer({antialias: true});
renderer1.setPixelRatio(window.devicePixelRatio); renderer2.setPixelRatio(window.devicePixelRatio);
function render() {
  renderer1.render(scene1, camera1);
  renderer2.render(scene2, camera2);
}

var preview1 = document.getElementById('preview1'), preview2 = document.getElementById('preview2');
preview1.appendChild(renderer1.domElement); preview2.appendChild(renderer2.domElement);

function onWindowResize(){
  var w = window.innerHeight * 0.9;//preview1.offsetWidth*0.8;
  var h = window.innerWidth * 0.9;//preview1.offsetHeight*0.8;
  w = h = Math.min(w, h);
  camera1.left = camera2.left = -w;
  camera1.right = camera2.right = w;
  camera1.top = camera2.top = h;
  camera1.bottom = camera2.bottom = -h;
  camera1.updateProjectionMatrix(); camera2.updateProjectionMatrix();
  renderer1.setSize(w, h); renderer2.setSize(w, h);
  render();
}
window.addEventListener('resize', onWindowResize, false);

// React to user input:
var controls1 = new THREE.OrbitControls(camera1, renderer1.domElement);
var controls2 = new THREE.OrbitControls(camera2, renderer2.domElement);
controls1.addEventListener('change', render); controls2.addEventListener('change', render);

// Used for setting up models in scenes:
var origo = new THREE.Vector3();
var inv = new THREE.Matrix3(); inv.set(1,0,0, 0,-1,0, 0,0,-1); // Invert Y, and Z-axis for LDraw

function showInScenes(ldr1, ldr2) {
  //console.log("Setting up scene for LDR: '" + ldr1 + ldr2 + "'");

  function showInScene(ldr, scene, camera, baseObject) {
    var ldrLoader = new THREE.LDRLoader(function(){}, {onError:onError, onWarning:onWarning});
    ldrLoader.parse(ldr);
    if(!ldrLoader.mainModel) {
      console.log('A valid model was not parsed. Nothing will be shown');
      return baseObject;
    }
    var mainModel = ldrLoader.ldrPartTypes[ldrLoader.mainModel]; // Main model from the LDraw file (first model encountered)
    var geometryBuilder = new LDR.GeometryBuilder(ldrLoader, {});
    geometryBuilder.build([mainModel]);
    
    if(baseObject) {
      scene.remove(baseObject);
    }
    baseObject = new THREE.Group();
    scene.add(baseObject);

    var opaqueObj = new THREE.Group();
    baseObject.add(opaqueObj);
    var transObj = new THREE.Group();
    baseObject.add(transObj);

    var mc = new LDR.MeshCollector(opaqueObj, transObj);
    mainModel.generateThreePart(ldrLoader, 16, origo, inv, true, false, mc);

    // Find center of drawn model:
    var b = mc.boundingBox;
    var elementCenter = new THREE.Vector3();
    b.getCenter(elementCenter);
    baseObject.position.set(-elementCenter.x, -elementCenter.y, -elementCenter.z);
    //baseObject.add(new THREE.Box3Helper(b, 0xff0000)); // Uncomment if you want to see the bounding box

    camera.zoom = window.innerWidth/b.min.distanceTo(b.max);
    return baseObject;
  }

  // First handle preview:
  baseObject1 = showInScene(ldr1, scene1, camera1, baseObject1);

  // Then the folded model:
  baseObject2 = showInScene(ldr2, scene2, camera2, baseObject2);

  onWindowResize();
}

/*
  Folding
 */
function fold(ldr) {
  resetWarningsAndErrors();

  if(!ldr) { // Fetch from text area:
    ldr = $('#file_content')[0].value;
  }
  else { // Update text area:
    $('#file_content').val(ldr);
  }

  var [paths,header] = UTIL.ldr2Paths(ldr, onWarning);

  // Get heightPoints from text area:
  var mapper = new LDR.LinearHeightMap($('#surface')[0].value);
  paths = mapper.foldPaths(paths);

  // LDraw content:
  var lDrawContent = UTIL.paths2LDraw(paths, header);
  $('#ldr_result').val(lDrawContent);
  showInScenes(ldr, lDrawContent + mapper.toLDR());
}

function setUpMaps() {
  var mapsEle = $('#maps')[0];
  MAPS.ALL.forEach(map => map.toEle(mapsEle, fold, 100, 100));
}

function readFromFile(event) {
  var reader = new FileReader();
  reader.onload = function(){
    fold(reader.result);
  };
  reader.readAsText(event.target.files[0]);
}

function readFromUrl(event) {
  var url = event.target.value;
  console.log('Reading from URL ' + url);
  var req = new XMLHttpRequest();
  req.onreadystatechange = function() {
    if(req.readyState != 4)
      return;
    if(req.status != 200) {
      console.dir(event);
      return;
    }
    fold(req.responseText);
  };
  req.open('GET', url, true);
  req.send();
}

function copyToClipboard() {
  $('#ldr_result')[0].select();
  document.execCommand('copy');
}

$(document).ready(function() {
  setUpMaps();
  fold();
});
  </script>
 </body>
</html>
